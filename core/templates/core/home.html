{% extends 'core/base.html' %}

{% block content %}
<div class="text-center">
    <h1 class="display-5 text-success fw-bold">–í—Ä–µ–º—è –ù–∞–º–∞–∑–∞</h1>
    <p class="lead text-muted">–¢–æ—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –º—É—Å—É–ª—å–º–∞–Ω</p>

    <div class="mt-4" id="location-section">
        <button id="getLocationBtn" class="btn btn-primary btn-lg">
            üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <div id="loading" class="mt-3" style="display: none;">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="text-muted mt-2">–ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∏–±–ª—ã...</p>
        </div>
    </div>

    <!-- –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ -->
    <div id="prayer-times" class="mt-5" style="display: none;">
        <h3>–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="prayer-list" class="list-group mt-3"></div>
        <p class="text-muted mt-3">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–º–∞–∑–∞.</p>
    </div>

    <!-- –ö–∏–±–ª–∞-–∫–æ–º–ø–∞—Å -->
    <div id="qibla-section" class="mt-5" style="display: none;">
        <h3>–ö–∏–±–ª–∞ (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ö–∞–∞–±—É)</h3>
        <p class="text-muted">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.</p>

        <div class="position-relative" style="width: 250px; height: 250px; margin: 0 auto;">
            <div id="compass" class="position-relative" style="width: 100%; height: 100%; border-radius: 50%; border: 4px solid #1e7e34; background: #f8f9fa; display: flex; justify-content: center; align-items: center;">
                <div id="qibla-arrow" style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 8px;
                    height: 100px;
                    background: #d9534f;
                    transform-origin: bottom center;
                    transform: translate(-50%, -100%) rotate(0deg);
                    border-radius: 4px;
                "></div>
                <div style="width: 16px; height: 16px; background: #1e7e34; border-radius: 50%; z-index: 10;"></div>
            </div>
        </div>

        <p class="mt-3 text-center">
            –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <span id="qibla-angle">‚Äî</span>¬∞ –æ—Ç —Å–µ–≤–µ—Ä–∞
        </p>

        <button id="calibrateBtn" class="btn btn-outline-secondary btn-sm mt-2">
            –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞—Å
        </button>
    </div>

    <!-- –û—à–∏–±–∫–∏ -->
    <div id="error" class="alert alert-danger mt-4" style="display: none;"></div>

    <!-- –°—á—ë—Ç—á–∏–∫ –∑–∏–∫—Ä–∞ -->
    <div class="mt-5">
        <h3>–°—á—ë—Ç—á–∏–∫ –∑–∏–∫—Ä–∞</h3>
        <p class="text-muted">–ü–æ–¥—Å—á—ë—Ç –ø–æ–º–∏–Ω–∞–Ω–∏–π –ê–ª–ª–∞—Ö–∞</p>

        <div class="row justify-content-center mt-3">
            <div class="col-md-6">
                <div class="d-flex gap-2 mb-3">
                    <select id="dhikrType" class="form-select">
                        <option value="–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö</option>
                        <option value="–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö">–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö</option>
                        <option value="–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä">–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä</option>
                        <option value="–õ—è –∏–ª—è—Ö–∞ –∏–ª–ª—è–õ–ª–∞—Ö">–õ—è –∏–ª—è—Ö–∞ –∏–ª–ª—è–õ–ª–∞—Ö</option>
                    </select>
                    <select id="targetSelect" class="form-select">
                        <option value="33">–¶–µ–ª—å: 33</option>
                        <option value="99">–¶–µ–ª—å: 99</option>
                        <option value="100">–¶–µ–ª—å: 100</option>
                    </select>
                </div>

                <div class="d-flex justify-content-center align-items-center mb-3">
                    <span id="dhikr-text" class="fs-4 me-3">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö</span>
                    <span id="counter" class="fs-1 fw-bold text-success">0</span>
                </div>

                <div class="d-grid gap-2">
                    <button id="incrementBtn" class="btn btn-success btn-lg">+1</button>
                    <button id="resetBtn" class="btn btn-outline-secondary">–°–±—Ä–æ—Å</button>
                </div>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        –û—Å—Ç–∞–ª–æ—Å—å: <span id="remaining">33</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ—Ä–∞–Ω -->
    <div class="mt-5">
        <h3>–°–≤—è—â–µ–Ω–Ω—ã–π –ö–æ—Ä–∞–Ω</h3>
        <p class="text-muted">–ß—Ç–µ–Ω–∏–µ –∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ</p>

        <div class="row justify-content-center mt-3">
            <div class="col-md-6">
                <select id="surahSelect" class="form-select mb-3">
                    <!-- –°—É—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ -->
                </select>

                <div id="quran-content" class="bg-white p-4 rounded shadow-sm text-end" dir="rtl" lang="ar">
                    <p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>

                <div class="mt-3 d-grid gap-2">
                    <button id="playAudioBtn" class="btn btn-outline-primary" disabled>
                        üéß –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function formatTime(dateStr) {
    const [hours, minutes] = dateStr.split(':').map(Number);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const h = hours % 12 || 12;
    return `${h}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

// === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
function requestNotificationPermission() {
    if (!("Notification" in window)) {
        return Promise.resolve(false);
    }
    if (Notification.permission === "granted") {
        return Promise.resolve(true);
    }
    if (Notification.permission === "denied") {
        showError("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
        return Promise.resolve(false);
    }
    return Notification.requestPermission().then(permission => {
        return permission === "granted";
    });
}

function showPrayerNotification(prayerName) {
    if (Notification.permission === "granted") {
        new Notification(`–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞: ${prayerName}`, {
            body: `–ù–∞—Å—Ç—É–ø–∏–ª–æ –≤—Ä–µ–º—è –º–æ–ª–∏—Ç–≤—ã ${prayerName}.`,
            icon: "/static/icon-192.png",
            badge: "/static/icon-192.png"
        });
    }
}

function timeToMs(timeStr) {
    const [h, m] = timeStr.split(':').map(Number);
    return h * 3600000 + m * 60000;
}

function scheduleNotifications(timings) {
    const now = new Date();
    const nowMs = now.getHours() * 3600000 + now.getMinutes() * 60000 + now.getSeconds() * 1000;

    const prayers = [
        { key: 'Fajr', name: '–§–∞–¥–∂—Ä' },
        { key: 'Dhuhr', name: '–ó—É—Ö—Ä' },
        { key: 'Asr', name: '–ê—Å—Ä' },
        { key: 'Maghrib', name: '–ú–∞–≥—Ä–∏–±' },
        { key: 'Isha', name: '–ò—à–∞' }
    ];

    prayers.forEach(p => {
        const prayerTimeMs = timeToMs(timings[p.key]);
        let delay = prayerTimeMs - nowMs;
        if (delay <= 0) delay += 24 * 3600000;
        setTimeout(() => showPrayerNotification(p.name), delay);
    });
    console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.");
}

// === –í–†–ï–ú–Ø –ù–ê–ú–ê–ó–ê ===
function displayPrayerTimes(data) {
    const prayerList = document.getElementById('prayer-list');
    prayerList.innerHTML = '';

    const prayers = [
        { key: 'Fajr', name: '–§–∞–¥–∂—Ä (–†–∞—Å—Å–≤–µ—Ç)' },
        { key: 'Dhuhr', name: '–ó—É—Ö—Ä (–ü–æ–ª–¥–µ–Ω—å)' },
        { key: 'Asr', name: '–ê—Å—Ä (–ü–æ—Å–ª–µ –ø–æ–ª—É–¥–Ω—è)' },
        { key: 'Maghrib', name: '–ú–∞–≥—Ä–∏–± (–ó–∞–∫–∞—Ç)' },
        { key: 'Isha', name: '–ò—à–∞ (–ù–æ—á—å)' }
    ];

    prayers.forEach(p => {
        const time24 = data.timings[p.key];
        const time12 = formatTime(time24);
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `<strong>${p.name}</strong><span>${time12} (${time24})</span>`;
        prayerList.appendChild(item);
    });

    document.getElementById('prayer-times').style.display = 'block';

    requestNotificationPermission().then(granted => {
        if (granted) scheduleNotifications(data.timings);
    });
}

function fetchPrayerTimes(lat, lng) {
    const method = 2;
    const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=${method}&school=0`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
            return response.json();
        })
        .then(result => {
            if (result.code !== 200) throw new Error('–û—à–∏–±–∫–∞ API');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('getLocationBtn').disabled = false;
            displayPrayerTimes(result.data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞.');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('getLocationBtn').disabled = false;
        });
}

// === –ö–ò–ë–õ–ê-–ö–û–ú–ü–ê–° ===
let qiblaDirection = null;
const KAABA_LAT = 21.4225;
const KAABA_LNG = 39.8262;

function calculateQibla(lat, lng) {
    const phi1 = (lat * Math.PI) / 180;
    const phi2 = (KAABA_LAT * Math.PI) / 180;
    const deltaLambda = ((KAABA_LNG - lng) * Math.PI) / 180;

    const y = Math.sin(deltaLambda) * Math.cos(phi2);
    const x = Math.cos(phi1) * Math.sin(phi2) -
              Math.sin(phi1) * Math.cos(phi2) * Math.cos(deltaLambda);

    let theta = Math.atan2(y, x);
    theta = (theta * 180) / Math.PI;
    return (theta + 360) % 360;
}

function updateCompass(heading) {
    if (qiblaDirection === null) return;
    const rotation = qiblaDirection - heading;
    document.getElementById('qibla-arrow').style.transform =
        `translate(-50%, -100%) rotate(${rotation}deg)`;
}

let compassSupported = false;
if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    document.getElementById('calibrateBtn').addEventListener('click', () => {
        DeviceOrientationEvent.requestPermission()
            .then(permission => {
                if (permission === 'granted') {
                    window.addEventListener('deviceorientation', handleOrientation);
                    compassSupported = true;
                    document.getElementById('calibrateBtn').textContent = '–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω';
                }
            })
            .catch(console.error);
    });
} else if (typeof DeviceOrientationEvent !== 'undefined') {
    window.addEventListener('deviceorientation', handleOrientation);
    compassSupported = true;
    document.getElementById('calibrateBtn').style.display = 'none';
}

function handleOrientation(event) {
    let heading = null;
    if (event.webkitCompassHeading) {
        heading = event.webkitCompassHeading;
    } else if (event.alpha !== null) {
        heading = event.alpha;
    }
    if (heading !== null) updateCompass(heading);
}

function showQiblaCompass(lat, lng) {
    qiblaDirection = calculateQibla(lat, lng);
    document.getElementById('qibla-angle').textContent = qiblaDirection.toFixed(1);
    document.getElementById('qibla-section').style.display = 'block';
}

// === –°–ß–Å–¢–ß–ò–ö –ó–ò–ö–†–ê ===
let count = 0;
let target = 33;

function updateCounter() {
    const remaining = Math.max(0, target - count);
    document.getElementById('counter').textContent = count;
    document.getElementById('remaining').textContent = remaining;

    const counterEl = document.getElementById('counter');
    if (count >= target) {
        counterEl.classList.add('text-primary');
    } else {
        counterEl.classList.remove('text-primary');
    }
}

function saveToStorage() {
    const type = document.getElementById('dhikrType').value;
    const targetVal = document.getElementById('targetSelect').value;
    localStorage.setItem('dhikr_count', count);
    localStorage.setItem('dhikr_type', type);
    localStorage.setItem('dhikr_target', targetVal);
}

function loadFromStorage() {
    const savedCount = localStorage.getItem('dhikr_count');
    const savedType = localStorage.getItem('dhikr_type');
    const savedTarget = localStorage.getItem('dhikr_target');

    if (savedCount !== null) count = parseInt(savedCount, 10);
    if (savedType) {
        document.getElementById('dhikrType').value = savedType;
        document.getElementById('dhikr-text').textContent = savedType;
    }
    if (savedTarget) {
        document.getElementById('targetSelect').value = savedTarget;
        target = parseInt(savedTarget, 10);
    }
    updateCounter();
}

document.getElementById('incrementBtn').addEventListener('click', () => {
    count++;
    updateCounter();
    saveToStorage();
});

document.getElementById('resetBtn').addEventListener('click', () => {
    count = 0;
    updateCounter();
    saveToStorage();
});

document.getElementById('dhikrType').addEventListener('change', (e) => {
    const text = e.target.value;
    document.getElementById('dhikr-text').textContent = text;
    saveToStorage();
});

document.getElementById('targetSelect').addEventListener('change', (e) => {
    target = parseInt(e.target.value, 10);
    updateCounter();
    saveToStorage();
});

loadFromStorage();

// === –ö–û–†–ê–ù ===
let currentSurah = 1;

function loadSurahList() {
    fetch('https://api.quran.com/api/v4/chapters?language=ru')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('surahSelect');
            data.chapters.forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch.id;
                opt.textContent = `${ch.id}. ${ch.name_simple}`;
                select.appendChild(opt);
            });
            loadSurah(1);
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å—É—Ä:', err);
            document.getElementById('quran-content').innerHTML = '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—É—Ä.</p>';
        });
}

function loadSurah(surahId) {
    currentSurah = surahId;
    document.getElementById('playAudioBtn').disabled = true;
    document.getElementById('quran-content').innerHTML = '<p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';

    fetch(`https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${surahId}`)
        .then(response => response.json())
        .then(data => {
            let html = '';
            data.verses.forEach(verse => {
                html += `<p class="mb-3"><span class="text-muted">${verse.verse_number}.</span> ${verse.text_uthmani}</p>`;
            });
            document.getElementById('quran-content').innerHTML = html;
            document.getElementById('playAudioBtn').disabled = false;
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—É—Ä—ã:', err);
            document.getElementById('quran-content').innerHTML = '<p class="text-danger">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—Ä—É.</p>';
        });
}

document.getElementById('surahSelect').addEventListener('change', (e) => {
    loadSurah(e.target.value);
});

document.getElementById('playAudioBtn').addEventListener('click', () => {
    const audioUrl = `https://audio.qurancdn.com/MaherAlMuaiqly/${String(currentSurah).padStart(3, '0')}.mp3`;
    const audio = new Audio(audioUrl);
    audio.play().catch(e => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        console.error('Audio error:', e);
    });
});

loadSurahList();

// === –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ===
function getLocation() {
    const btn = document.getElementById('getLocationBtn');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');

    errorDiv.style.display = 'none';
    loading.style.display = 'block';
    btn.disabled = true;

    if (!navigator.geolocation) {
        showError('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.');
        loading.style.display = 'none';
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const { latitude, longitude } = pos.coords;
            fetchPrayerTimes(latitude, longitude);
            showQiblaCompass(latitude, longitude);
        },
        (error) => {
            let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.';
            if (error.code === 1) msg = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω.';
            else if (error.code === 2) msg = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏.';
            else if (error.code === 3) msg = '–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.';
            showError(msg);
            loading.style.display = 'none';
            btn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
    );
}

document.getElementById('getLocationBtn').addEventListener('click', getLocation);
</script>
{% endblock %}