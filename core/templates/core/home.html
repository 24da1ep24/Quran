{% extends 'core/base.html' %}

{% block content %}
<div class="text-center">
    <h1 class="display-5 text-success fw-bold">–í—Ä–µ–º—è –ù–∞–º–∞–∑–∞</h1>
    <p class="lead text-muted">–¢–æ—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –º—É—Å—É–ª—å–º–∞–Ω</p>

    <div class="mt-4" id="location-section">
        <button id="getLocationBtn" class="btn btn-primary btn-lg">
            üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <div id="loading" class="mt-3" style="display: none;">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="text-muted mt-2">–ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ö–∏–±–ª—ã...</p>
        </div>
    </div>

    <!-- –í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ -->
    <div id="prayer-times" class="mt-5" style="display: none;">
        <h3>–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
        <div id="prayer-list" class="list-group mt-3"></div>
        <p class="text-muted mt-3">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–º–∞–∑–∞.</p>
    </div>

    <!-- –ö–∏–±–ª–∞-–∫–æ–º–ø–∞—Å -->
    <div id="qibla-section" class="mt-5" style="display: none;">
        <h3>–ö–∏–±–ª–∞ (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ö–∞–∞–±—É)</h3>
        <p class="text-muted">–ü–æ–≤–µ—Ä–Ω–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.</p>

        <div class="position-relative" style="width: 250px; height: 250px; margin: 0 auto;">
            <div id="compass" class="position-relative" style="width: 100%; height: 100%; border-radius: 50%; border: 4px solid #1e7e34; background: #f8f9fa; display: flex; justify-content: center; align-items: center;">
                <div id="qibla-arrow" style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    width: 8px;
                    height: 100px;
                    background: #d9534f;
                    transform-origin: bottom center;
                    transform: translate(-50%, -100%) rotate(0deg);
                    border-radius: 4px;
                "></div>
                <div style="width: 16px; height: 16px; background: #1e7e34; border-radius: 50%; z-index: 10;"></div>
            </div>
        </div>

        <p class="mt-3 text-center">
            –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <span id="qibla-angle">‚Äî</span>¬∞ –æ—Ç —Å–µ–≤–µ—Ä–∞
        </p>

        <button id="calibrateBtn" class="btn btn-outline-secondary btn-sm mt-2">
            –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞—Å
        </button>
    </div>

    <!-- –û—à–∏–±–∫–∏ -->
    <div id="error" class="alert alert-danger mt-4" style="display: none;"></div>

    <!-- –°—á—ë—Ç—á–∏–∫ –∑–∏–∫—Ä–∞ -->
    <div class="mt-5">
        <h3>–°—á—ë—Ç—á–∏–∫ –∑–∏–∫—Ä–∞</h3>
        <p class="text-muted">–ü–æ–¥—Å—á—ë—Ç –ø–æ–º–∏–Ω–∞–Ω–∏–π –ê–ª–ª–∞—Ö–∞</p>

        <div class="row justify-content-center mt-3">
            <div class="col-md-6">
                <div class="d-flex gap-2 mb-3">
                    <select id="dhikrType" class="form-select">
                        <option value="–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö</option>
                        <option value="–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö">–ê–ª—å—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö</option>
                        <option value="–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä">–ê–ª–ª–∞—Ö—É –ê–∫–±–∞—Ä</option>
                        <option value="–õ—è –∏–ª—è—Ö–∞ –∏–ª–ª—è–õ–ª–∞—Ö">–õ—è –∏–ª—è—Ö–∞ –∏–ª–ª—è–õ–ª–∞—Ö</option>
                    </select>
                    <select id="targetSelect" class="form-select">
                        <option value="33">–¶–µ–ª—å: 33</option>
                        <option value="99">–¶–µ–ª—å: 99</option>
                        <option value="100">–¶–µ–ª—å: 100</option>
                    </select>
                </div>

                <div class="d-flex justify-content-center align-items-center mb-3">
                    <span id="dhikr-text" class="fs-4 me-3">–°—É–±—Ö–∞–Ω–∞–ª–ª–∞—Ö</span>
                    <span id="counter" class="fs-1 fw-bold text-success">0</span>
                </div>

                <div class="d-grid gap-2">
                    <button id="incrementBtn" class="btn btn-success btn-lg">+1</button>
                    <button id="resetBtn" class="btn btn-outline-secondary">–°–±—Ä–æ—Å</button>
                </div>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        –û—Å—Ç–∞–ª–æ—Å—å: <span id="remaining">33</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚úÖ –ö–û–†–ê–ù: –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è -->
    <div class="mt-5">
        <h3>–°–≤—è—â–µ–Ω–Ω—ã–π –ö–æ—Ä–∞–Ω</h3>
        <p class="text-muted">–ß—Ç–µ–Ω–∏–µ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏ –ø–µ—Ä–µ–≤–æ–¥</p>

        <div class="row justify-content-center mt-3">
            <div class="col-md-8">
                <!-- –í—ã–±–æ—Ä —Å—É—Ä—ã -->
                <div class="mb-4">
                    <select id="surahSelect" class="form-select form-select-lg mb-3">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—Ä—É...</option>
                    </select>

                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∞—è—Ç–∞–º -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button id="prevAyahBtn" class="btn btn-outline-secondary" disabled>
                            ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π –∞—è—Ç
                        </button>
                        <span id="currentAyahInfo" class="text-muted">–ê—è—Ç 1 –∏–∑ 1</span>
                        <button id="nextAyahBtn" class="btn btn-outline-secondary" disabled>
                            –°–ª–µ–¥—É—é—â–∏–π –∞—è—Ç ‚Üí
                        </button>
                    </div>
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞—è—Ç–∞ -->
                <div id="quran-container" class="bg-white p-4 rounded shadow-sm">
                    <div id="quran-content" style="display: none;">
                        <!-- –ê—Ä–∞–±—Å–∫–∏–π —Ç–µ–∫—Å—Ç -->
                        <div class="text-end mb-4" dir="rtl" lang="ar" style="font-family: 'Amiri', serif; font-size: 1.8rem; line-height: 1.8;">
                            <h4 id="arabic-text" class="mb-3"></h4>
                            <small class="text-muted">–ê—è—Ç <span id="ayah-number">1</span></small>
                        </div>

                        <!-- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è -->
                        <div class="mb-4">
                            <h5 class="text-muted mb-2">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</h5>
                            <p id="transcription-text" class="fs-5"></p>
                        </div>

                        <!-- –ü–µ—Ä–µ–≤–æ–¥ -->
                        <div>
                            <h5 class="text-muted mb-2">–ü–µ—Ä–µ–≤–æ–¥</h5>
                            <p id="translation-text" class="fs-5"></p>
                        </div>

                        <!-- –ê—É–¥–∏–æ -->
                        <div class="mt-4 pt-3 border-top">
                            <button id="playAudioBtn" class="btn btn-outline-primary me-2" disabled>
                                üéß –°–ª—É—à–∞—Ç—å –∞—è—Ç
                            </button>
                            <button id="playFullSurahBtn" class="btn btn-outline-success" disabled>
                                ‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å –≤—Å—é —Å—É—Ä—É
                            </button>
                            <small class="text-muted d-block mt-2" id="audio-info"></small>
                        </div>
                    </div>

                    <div id="loading-quran" class="text-center py-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="text-muted mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ –ö–æ—Ä–∞–Ω–∞...</p>
                    </div>

                    <div id="error-quran" class="alert alert-danger" style="display: none;"></div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ islam.global -->
                <div class="mt-4">
                    <a id="fullSurahLink" href="#" target="_blank" class="btn btn-link">
                        üìñ –ß–∏—Ç–∞—Ç—å –≤—Å—é —Å—É—Ä—É –Ω–∞ islam.global
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –•–∞–¥–∏—Å –¥–Ω—è -->
    <div class="mt-5">
        <h3>–•–∞–¥–∏—Å –¥–Ω—è</h3>
        <p class="text-muted">–ò–∑ —Å–±–æ—Ä–Ω–∏–∫–∞ ¬´–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏¬ª</p>

        <div class="bg-white p-4 rounded shadow-sm text-start" dir="ltr">
            <blockquote id="hadith-text" class="fs-5 fst-italic mb-3">
                –ó–∞–≥—Ä—É–∑–∫–∞ —Ö–∞–¥–∏—Å–∞...
            </blockquote>
            <footer class="text-end text-muted">
                ‚Äî <cite id="hadith-ref">–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏</cite>
            </footer>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function formatTime(dateStr) {
    const [hours, minutes] = dateStr.split(':').map(Number);
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const h = hours % 12 || 12;
    return `${h}:${minutes.toString().padStart(2, '0')} ${ampm}`;
}

// === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
function requestNotificationPermission() {
    if (!("Notification" in window)) {
        return Promise.resolve(false);
    }
    if (Notification.permission === "granted") {
        return Promise.resolve(true);
    }
    if (Notification.permission === "denied") {
        showError("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.");
        return Promise.resolve(false);
    }
    return Notification.requestPermission().then(permission => {
        return permission === "granted";
    });
}

function showPrayerNotification(prayerName) {
    if (Notification.permission === "granted") {
        new Notification(`–í—Ä–µ–º—è –Ω–∞–º–∞–∑–∞: ${prayerName}`, {
            body: `–ù–∞—Å—Ç—É–ø–∏–ª–æ –≤—Ä–µ–º—è –º–æ–ª–∏—Ç–≤—ã ${prayerName}.`,
            icon: "/static/icon-192.png",
            badge: "/static/icon-192.png"
        });
    }
}

function timeToMs(timeStr) {
    const [h, m] = timeStr.split(':').map(Number);
    return h * 3600000 + m * 60000;
}

function scheduleNotifications(timings) {
    const now = new Date();
    const nowMs = now.getHours() * 3600000 + now.getMinutes() * 60000 + now.getSeconds() * 1000;

    const prayers = [
        { key: 'Fajr', name: '–§–∞–¥–∂—Ä' },
        { key: 'Dhuhr', name: '–ó—É—Ö—Ä' },
        { key: 'Asr', name: '–ê—Å—Ä' },
        { key: 'Maghrib', name: '–ú–∞–≥—Ä–∏–±' },
        { key: 'Isha', name: '–ò—à–∞' }
    ];

    prayers.forEach(p => {
        const prayerTimeMs = timeToMs(timings[p.key]);
        let delay = prayerTimeMs - nowMs;
        if (delay <= 0) delay += 24 * 3600000;
        setTimeout(() => showPrayerNotification(p.name), delay);
    });
    console.log("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã.");
}

// === –í–†–ï–ú–Ø –ù–ê–ú–ê–ó–ê ===
function displayPrayerTimes(data) {
    const prayerList = document.getElementById('prayer-list');
    prayerList.innerHTML = '';

    const prayers = [
        { key: 'Fajr', name: '–§–∞–¥–∂—Ä (–†–∞—Å—Å–≤–µ—Ç)' },
        { key: 'Dhuhr', name: '–ó—É—Ö—Ä (–ü–æ–ª–¥–µ–Ω—å)' },
        { key: 'Asr', name: '–ê—Å—Ä (–ü–æ—Å–ª–µ –ø–æ–ª—É–¥–Ω—è)' },
        { key: 'Maghrib', name: '–ú–∞–≥—Ä–∏–± (–ó–∞–∫–∞—Ç)' },
        { key: 'Isha', name: '–ò—à–∞ (–ù–æ—á—å)' }
    ];

    prayers.forEach(p => {
        const time24 = data.timings[p.key];
        const time12 = formatTime(time24);
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `<strong>${p.name}</strong><span>${time12} (${time24})</span>`;
        prayerList.appendChild(item);
    });

    document.getElementById('prayer-times').style.display = 'block';

    requestNotificationPermission().then(granted => {
        if (granted) scheduleNotifications(data.timings);
    });
}

function fetchPrayerTimes(lat, lng) {
    const method = 2;
    const url = `https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lng}&method=${method}&school=0`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
            return response.json();
        })
        .then(result => {
            if (result.code !== 200) throw new Error('–û—à–∏–±–∫–∞ API');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('getLocationBtn').disabled = false;
            displayPrayerTimes(result.data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞.');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('getLocationBtn').disabled = false;
        });
}

// === –ö–ò–ë–õ–ê-–ö–û–ú–ü–ê–° ===
let qiblaDirection = null;
const KAABA_LAT = 21.4225;
const KAABA_LNG = 39.8262;

function calculateQibla(lat, lng) {
    const phi1 = (lat * Math.PI) / 180;
    const phi2 = (KAABA_LAT * Math.PI) / 180;
    const deltaLambda = ((KAABA_LNG - lng) * Math.PI) / 180;

    const y = Math.sin(deltaLambda) * Math.cos(phi2);
    const x = Math.cos(phi1) * Math.sin(phi2) -
              Math.sin(phi1) * Math.cos(phi2) * Math.cos(deltaLambda);

    let theta = Math.atan2(y, x);
    theta = (theta * 180) / Math.PI;
    return (theta + 360) % 360;
}

function updateCompass(heading) {
    if (qiblaDirection === null) return;
    const rotation = qiblaDirection - heading;
    document.getElementById('qibla-arrow').style.transform =
        `translate(-50%, -100%) rotate(${rotation}deg)`;
}

let compassSupported = false;
if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    document.getElementById('calibrateBtn').addEventListener('click', () => {
        DeviceOrientationEvent.requestPermission()
            .then(permission => {
                if (permission === 'granted') {
                    window.addEventListener('deviceorientation', handleOrientation);
                    compassSupported = true;
                    document.getElementById('calibrateBtn').textContent = '–ö–æ–º–ø–∞—Å –∞–∫—Ç–∏–≤–µ–Ω';
                }
            })
            .catch(console.error);
    });
} else if (typeof DeviceOrientationEvent !== 'undefined') {
    window.addEventListener('deviceorientation', handleOrientation);
    compassSupported = true;
    document.getElementById('calibrateBtn').style.display = 'none';
}

function handleOrientation(event) {
    let heading = null;
    if (event.webkitCompassHeading) {
        heading = event.webkitCompassHeading;
    } else if (event.alpha !== null) {
        heading = event.alpha;
    }
    if (heading !== null) updateCompass(heading);
}

function showQiblaCompass(lat, lng) {
    qiblaDirection = calculateQibla(lat, lng);
    document.getElementById('qibla-angle').textContent = qiblaDirection.toFixed(1);
    document.getElementById('qibla-section').style.display = 'block';
}

// === –°–ß–Å–¢–ß–ò–ö –ó–ò–ö–†–ê ===
let count = 0;
let target = 33;

function updateCounter() {
    const remaining = Math.max(0, target - count);
    document.getElementById('counter').textContent = count;
    document.getElementById('remaining').textContent = remaining;

    const counterEl = document.getElementById('counter');
    if (count >= target) {
        counterEl.classList.add('text-primary');
    } else {
        counterEl.classList.remove('text-primary');
    }
}

function saveToStorage() {
    const type = document.getElementById('dhikrType').value;
    const targetVal = document.getElementById('targetSelect').value;
    localStorage.setItem('dhikr_count', count);
    localStorage.setItem('dhikr_type', type);
    localStorage.setItem('dhikr_target', targetVal);
}

function loadFromStorage() {
    const savedCount = localStorage.getItem('dhikr_count');
    const savedType = localStorage.getItem('dhikr_type');
    const savedTarget = localStorage.getItem('dhikr_target');

    if (savedCount !== null) count = parseInt(savedCount, 10);
    if (savedType) {
        document.getElementById('dhikrType').value = savedType;
        document.getElementById('dhikr-text').textContent = savedType;
    }
    if (savedTarget) {
        document.getElementById('targetSelect').value = savedTarget;
        target = parseInt(savedTarget, 10);
    }
    updateCounter();
}

document.getElementById('incrementBtn').addEventListener('click', () => {
    count++;
    updateCounter();
    saveToStorage();
});

document.getElementById('resetBtn').addEventListener('click', () => {
    count = 0;
    updateCounter();
    saveToStorage();
});

document.getElementById('dhikrType').addEventListener('change', (e) => {
    const text = e.target.value;
    document.getElementById('dhikr-text').textContent = text;
    saveToStorage();
});

document.getElementById('targetSelect').addEventListener('change', (e) => {
    target = parseInt(e.target.value, 10);
    updateCounter();
    saveToStorage();
});

loadFromStorage();

// === ‚úÖ –ö–û–†–ê–ù (–ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ islam.global) ===
const surahsMap = {
    1: { name: "–ê–ª—å-–§–∞—Ç–∏—Ö–∞", url: "https://islam.global/verouchenie/koran/sura-1-al-fatiha-otkryvayushchaya/" },
    2: { name: "–ê–ª—å-–ë–∞–∫–∞—Ä–∞", url: "https://islam.global/verouchenie/koran/sura-2-al-bakara-korova/" },
    3: { name: "–ê–ª—å –ò–º—Ä–∞–Ω", url: "https://islam.global/verouchenie/koran/sura-3-al-imran-semeystvo-imrana/" },
    4: { name: "–ê–Ω-–ù–∏—Å–∞", url: "https://islam.global/verouchenie/koran/sura-4-an-nisa-zhenshchiny/" },
    5: { name: "–ê–ª—å-–ú–∞–∏–¥–∞", url: "https://islam.global/verouchenie/koran/sura-5-al-maida-trapeza/" },
    6: { name: "–ê–ª—å-–ê–Ω–∞–º", url: "https://islam.global/verouchenie/koran/sura-6-al-anam-skot/" },
    7: { name: "–ê–ª—å-–ê—Ä–∞—Ñ", url: "https://islam.global/verouchenie/koran/sura-7-al-araf-predely/" },
    8: { name: "–ê–ª—å-–ê–Ω—Ñ–∞–ª—å", url: "https://islam.global/verouchenie/koran/sura-8-al-anfal-dobycha/" },
    9: { name: "–ê—Ç-–¢–∞—É–±–∞", url: "https://islam.global/verouchenie/koran/sura-9-at-tauba-pokaianie/" },
    10: { name: "–Æ–Ω—É—Å", url: "https://islam.global/verouchenie/koran/sura-10-yunus-iunus/" },
    11: { name: "–•—É–¥", url: "https://islam.global/verouchenie/koran/sura-11-hud-khud/" },
    12: { name: "–Æ—Å—É—Ñ", url: "https://islam.global/verouchenie/koran/sura-12-yusuf-iisuf/" },
    13: { name: "–ê—Ä-–†–∞–¥", url: "https://islam.global/verouchenie/koran/sura-13-ar-rad-grom/" },
    14: { name: "–ò–±—Ä–∞—Ö–∏–º", url: "https://islam.global/verouchenie/koran/sura-14-ibrahim-ibragim/" },
    15: { name: "–ê–ª—å-–•–∏–¥–∂—Ä", url: "https://islam.global/verouchenie/koran/sura-15-al-hidzhrakamennye-zemli/" },
    16: { name: "–ê–Ω-–ù–∞—Ö–ª—å", url: "https://islam.global/verouchenie/koran/sura-16-an-nakhl-pchela/" },
    17: { name: "–ê–ª—å-–ò—Å—Ä–∞", url: "https://islam.global/verouchenie/koran/sura-17-al-isra-puteshestvie-nochiu/" },
    18: { name: "–ê–ª—å-–ö–∞—Ö—Ñ", url: "https://islam.global/verouchenie/koran/sura-18-al-kakhf-peshchera/" },
    19: { name: "–ú–∞—Ä—å—è–º", url: "https://islam.global/verouchenie/koran/sura-19-maryam-mariiam/" },
    20: { name: "–¢–∞ –•–∞", url: "https://islam.global/verouchenie/koran/sura-20-ta-kha-ta-kha/" },
    21: { name: "–ê–ª—å-–ê–Ω–±–∏—è", url: "https://islam.global/verouchenie/koran/sura-21-al-anbiya-proroki/" },
    22: { name: "–ê–ª—å-–•–∞–¥–∂–∂", url: "https://islam.global/verouchenie/koran/sura-22-al-khadzhzh-palomnichestvo/" },
    23: { name: "–ê–ª—å-–ú—É–º–∏–Ω—É–Ω", url: "https://islam.global/verouchenie/koran/sura-23-al-muminun-veruiushchie/" },
    24: { name: "–ê–Ω-–ù—É—Ä", url: "https://islam.global/verouchenie/koran/sura-24-an-nur-svet/" },
    25: { name: "–ê–ª—å-–§—É—Ä–∫–∞–Ω", url: "https://islam.global/verouchenie/koran/sura-25-al-furkan-razlichenie/" },
    26: { name: "–ê—à-–®—É–∞—Ä–∞", url: "https://islam.global/verouchenie/koran/sura-26-ash-shuara-poety/" },
    27: { name: "–ê–Ω-–ù–∞–º–ª—å", url: "https://islam.global/verouchenie/koran/sura-27-an-naml-muravi/" },
    28: { name: "–ê–ª—å-–ö–∞—Å–∞—Å", url: "https://islam.global/verouchenie/koran/sura-28-al-kasas-rasskaz/" },
    29: { name: "–ê–ª—å-–ê–Ω–∫–∞–±—É—Ç", url: "https://islam.global/verouchenie/koran/sura-29-al-ankabut-pauk/" },
    30: { name: "–ê—Ä-–†—É–º", url: "https://islam.global/verouchenie/koran/sura-30-ar-rum-rimliane/" },
    31: { name: "–õ—É–∫–º–∞–Ω", url: "https://islam.global/verouchenie/koran/sura-31-lukman-lukman/" },
    32: { name: "–ê—Å-–°–∞–¥–∂–¥–∞", url: "https://islam.global/verouchenie/koran/sura-32-as-sadzhda-pokloneniie/" },
    33: { name: "–ê–ª—å-–ê—Ö–∑–∞–±", url: "https://islam.global/verouchenie/koran/sura-33-al-akhzab-soiuzy/" },
    34: { name: "–°–∞–±–∞", url: "https://islam.global/verouchenie/koran/sura-34-saba-sava/" },
    35: { name: "–§–∞—Ç—ã—Ä", url: "https://islam.global/verouchenie/koran/sura-35-fatyr-tvorets/" },
    36: { name: "–ô–∞ –°–∏–Ω", url: "https://islam.global/verouchenie/koran/sura-36-ia-sin-ia-sin/" },
    37: { name: "–ê—Å-–°–∞—Ñ—Ñ–∞—Ç", url: "https://islam.global/verouchenie/koran/sura-37-as-saffat-stroiashchiesia-riadami/" },
    38: { name: "–°–∞–¥", url: "https://islam.global/verouchenie/koran/sura-38-sad-sad/" },
    39: { name: "–ê–∑-–ó—É–º–∞—Ä", url: "https://islam.global/verouchenie/koran/sura-39-az-zumar-tolpy/" },
    40: { name: "–ì–∞—Ñ–∏—Ä", url: "https://islam.global/verouchenie/koran/sura-40-gafir-proshchaiushchii/" },
    41: { name: "–§—É—Å—Å–∏–ª—è—Ç", url: "https://islam.global/verouchenie/koran/sura-41-fussilat-podrobno-raz" },
    42: { name: "–ê—à-–®—É—Ä–∞", url: "https://islam.global/verouchenie/koran/sura-42-ash-shura-soveshchanie/" },
    43: { name: "–ê–∑-–ó—É—Ö—Ä—É—Ñ", url: "https://islam.global/verouchenie/koran/sura-43-az-zukhruf-ukrasheniia/" },
    44: { name: "–ê–¥-–î—É—Ö–∞–Ω", url: "https://islam.global/verouchenie/koran/sura-44-ad-dukhan-dym/" },
    45: { name: "–ê–ª—å-–î–∂–∞—Å–∏—è", url: "https://islam.global/verouchenie/koran/sura-45-al-dzhasiia-kolenopreklo/" },
    46: { name: "–ê–ª—å-–ê—Ö–∫–∞—Ñ", url: "https://islam.global/verouchenie/koran/sura-46-al-akhkaf-peski/" },
    47: { name: "–ú—É—Ö–∞–º–º–∞–¥", url: "https://islam.global/verouchenie/koran/sura-47-muhammad-mukhammad/" },
    48: { name: "–ê–ª—å-–§–∞—Ç—Ö", url: "https://islam.global/verouchenie/koran/sura-48-al-fath-pobeda/" },
    49: { name: "–ê–ª—å-–•—É–¥–∂—É—Ä–∞—Ç", url: "https://islam.global/verouchenie/koran/sura-49-al-khudzhurat-komnaty/" },
    50: { name: "–ö–∞—Ñ", url: "https://islam.global/verouchenie/koran/sura-50-kaf-kaf/" },
    51: { name: "–ê–∑-–ó–∞—Ä–∏—è—Ç", url: "https://islam.global/verouchenie/koran/sura-51-az-zariat-rassevaiushchie/" },
    52: { name: "–ê—Ç-–¢—É—Ä", url: "https://islam.global/verouchenie/koran/sura-52-at-tur-gora/" },
    53: { name: "–ê–Ω-–ù–∞–¥–∂–º", url: "https://islam.global/verouchenie/koran/sura-53-an-nadzhm-zvezda/" },
    54: { name: "–ê–ª—å-–ö–∞–º–∞—Ä", url: "https://islam.global/verouchenie/koran/sura-54-al-kamar-luna/" },
    55: { name: "–ê—Ä-–†–∞—Ö–º–∞–Ω", url: "https://islam.global/verouchenie/koran/sura-55-ar-rakhman-milostivyi/" },
    56: { name: "–ê–ª—å-–í–∞–∫–∏–∞", url: "https://islam.global/verouchenie/koran/sura-56-al-vakia-sobytiie/" },
    57: { name: "–ê–ª—å-–•–∞–¥–∏–¥", url: "https://islam.global/verouchenie/koran/sura-57-al-khadid-zhelezo/" },
    58: { name: "–ê–ª—å-–ú—É–¥–∂–∞–¥–∞–ª—è", url: "https://islam.global/verouchenie/koran/sura-58-al-mudzhadala-prepir" },
    59: { name: "–ê–ª—å-–•–∞—à—Ä", url: "https://islam.global/verouchenie/koran/sura-59-al-khashr-ischeznovenie/" },
    60: { name: "–ê–ª—å-–ú—É–º—Ç–∞—Ö–∞–Ω–∞", url: "https://islam.global/verouchenie/koran/sura-60-al-mumtakhana-ispytu" },
    61: { name: "–ê—Å-–°–∞—Ñ—Ñ", url: "https://islam.global/verouchenie/koran/sura-61-as-saff-riady/" },
    62: { name: "–ê–ª—å-–î–∂—É–º—É–∞", url: "https://islam.global/verouchenie/koran/sura-62-al-dzhumua-pyatnichnaia-molitva/" },
    63: { name: "–ê–ª—å-–ú—É–Ω–∞—Ñ–∏–∫—É–Ω", url: "https://islam.global/verouchenie/koran/sura-63-al-munafikun-litsemery/" },
    64: { name: "–ê—Ç-–¢–∞–≥–∞–±—É–Ω", url: "https://islam.global/verouchenie/koran/sura-64-at-taghabun-vzaimnyi-obman/" },
    65: { name: "–ê—Ç-–¢–∞–ª–∞–∫", url: "https://islam.global/verouchenie/koran/sura-65-at-talak-razvod/" },
    66: { name: "–ê—Ç-–¢–∞—Ö—Ä–∏–º", url: "https://islam.global/verouchenie/koran/sura-66-at-takhrim-zapreshchenie/" },
    67: { name: "–ê–ª—å-–ú—É–ª—å–∫", url: "https://islam.global/verouchenie/koran/sura-67-al-mulk-vladych" },
    68: { name: "–ê–ª—å-–ö–∞–ª—è–º", url: "https://islam.global/verouchenie/koran/sura-68-al-kalam-pis" },
    69: { name: "–ê–ª—å-–•–∞–∫–∫–∞", url: "https://islam.global/verouchenie/koran/sura-69-al-khakka-istina/" },
    70: { name: "–ê–ª—å-–ú–∞–∞—Ä–∏–¥–∂", url: "https://islam.global/verouchenie/koran/sura-70-al-maaridzh-stupeni/" },
    71: { name: "–ù—É—Ö", url: "https://islam.global/verouchenie/koran/sura-71-nukh-nukh/" },
    72: { name: "–ê–ª—å-–î–∂–∏–Ω–Ω", url: "https://islam.global/verouchenie/koran/sura-72-al-dzhinn-dzhinny/" },
    73: { name: "–ê–ª—å-–ú—É–∑–∑–∞–º–º–∏–ª—å", url: "https://islam.global/verouchenie/koran/sura-73-al-muzzammil-zavernuv" },
    74: { name: "–ê–ª—å-–ú—É–¥–¥–∞—Å—Å–∏—Ä", url: "https://islam.global/verouchenie/koran/sura-74-al-muddassir-zakuta" },
    75: { name: "–ê–ª—å-–ö–∏—è–º–∞", url: "https://islam.global/verouchenie/koran/sura-75-al-kiyama-voskreseniie/" },
    76: { name: "–ê–ª—å-–ò–Ω—Å–∞–Ω", url: "https://islam.global/verouchenie/koran/sura-76-al-insan-chelovek/" },
    77: { name: "–ê–ª—å-–ú—É—Ä—Å–∞–ª—è—Ç", url: "https://islam.global/verouchenie/koran/sura-77-al-mursalat-napravlenn" },
    78: { name: "–ê–Ω-–ù–∞–±–∞", url: "https://islam.global/verouchenie/koran/sura-78-an-naba-vest" },
    79: { name: "–ê–Ω-–ù–∞–∑–∏–∞—Ç", url: "https://islam.global/verouchenie/koran/sura-79-an-naziat-vyr" },
    80: { name: "–ê–±–∞—Å–∞", url: "https://islam.global/verouchenie/koran/sura-80-abasa-nakhmurilsia/" },
    81: { name: "–ê—Ç-–¢–∞–∫–≤–∏—Ä", url: "https://islam.global/verouchenie/koran/sura-81-at-takvir-skruchivanie/" },
    82: { name: "–ê–ª—å-–ò–Ω—Ñ–∏—Ç–∞—Ä", url: "https://islam.global/verouchenie/koran/sura-82-al-infitar-raskrytiie/" },
    83: { name: "–ê–ª—å-–ú—É—Ç–∞—Ñ—Ñ–∏—Ñ–∏–Ω", url: "https://islam.global/verouchenie/koran/sura-83-al-mutaffifin-obmanyvaiushchie/" },
    84: { name: "–ê–ª—å-–ò–Ω—à–∏–∫–∞–∫", url: "https://islam.global/verouchenie/koran/sura-84-al-inshikak-razryv/" },
    85: { name: "–ê–ª—å-–ë—É—Ä—É–¥–∂", url: "https://islam.global/verouchenie/koran/sura-85-al-burudzh-sodruzhestvo-zvezd/" },
    86: { name: "–ê—Ç-–¢–∞—Ä–∏–∫", url: "https://islam.global/verouchenie/koran/sura-86-at-tarik-utrenn" },
    87: { name: "–ê–ª—å-–ê–ª—è", url: "https://islam.global/verouchenie/koran/sura-87-al-ala-vsevyshnii/" },
    88: { name: "–ê–ª—å-–ì–∞—à–∏–π–∞", url: "https://islam.global/verouchenie/koran/sura-88-al-gashiya-unich" },
    89: { name: "–ê–ª—å-–§–∞–¥–∂—Ä", url: "https://islam.global/verouchenie/koran/sura-89-al-fadzhr-zaria/" },
    90: { name: "–ê–ª—å-–ë–∞–ª–∞–¥", url: "https://islam.global/verouchenie/koran/sura-90-al-bala-gorod/" },
    91: { name: "–ê—à-–®–∞–º—Å", url: "https://islam.global/verouchenie/koran/sura-91-ash-shams-solntse/" },
    92: { name: "–ê–ª—å-–õ—è–π–ª—å", url: "https://islam.global/verouchenie/koran/sura-92-al-lail-noch/" },
    93: { name: "–ê–¥-–î—É—Ö–∞", url: "https://islam.global/verouchenie/koran/sura-93-ad-dukha-utrenn" },
    94: { name: "–ê—à-–®–∞—Ä—Ö", url: "https://islam.global/verouchenie/koran/sura-94-ash-sharh-raskryti" },
    95: { name: "–ê—Ç-–¢–∏–Ω", url: "https://islam.global/verouchenie/koran/sura-95-at-tin-smokovnica/" },
    96: { name: "–ê–ª—å-–ê–ª—è–∫", url: "https://islam.global/verouchenie/koran/sura-96-al-ala-sgustok-krovi/" },
    97: { name: "–ê–ª—å-–ö–∞–¥—Ä", url: "https://islam.global/verouchenie/koran/sura-97-al-kadr-moshch" },
    98: { name: "–ê–ª—å-–ë–∞–π–π–∏–Ω–∞", url: "https://islam.global/verouchenie/koran/sura-98-al-bayy-ina-iasnoe-znameniie/" },
    99: { name: "–ê–∑-–ó–∞–ª—å–∑–∞–ª—è", url: "https://islam.global/verouchenie/koran/sura-99-az-zalzalia-sotri" },
    100: { name: "–ê–ª—å-–ê–¥–∏—è—Ç", url: "https://islam.global/verouchenie/koran/sura-100-al-adiyat-mchashchiesia/" },
    101: { name: "–ê–ª—å-–ö–∞—Ä–∏–∞", url: "https://islam.global/verouchenie/koran/sura-101-al-karia-porazhaiushchee/" },
    102: { name: "–ê—Ç-–¢–∞–∫–∞—Å—É—Ä", url: "https://islam.global/verouchenie/koran/sura-102-at-takasur-stremleniie-k-pribyli/" },
    103: { name: "–ê–ª—å-–ê—Å—Ä", url: "https://islam.global/verouchenie/koran/sura-103-al-asr-vek/" },
    104: { name: "–ê–ª—å-–•—É–º–∞–∑–∞", url: "https://islam.global/verouchenie/koran/sura-104-al-khumaza-khulitel" },
    105: { name: "–ê–ª—å-–§–∏–ª—å", url: "https://islam.global/verouchenie/koran/sura-105-al-fil-sl" },
    106: { name: "–ö—É—Ä–∞–π—à", url: "https://islam.global/verouchenie/koran/sura-106-kuraish-kureish/" },
    107: { name: "–ê–ª—å-–ú–∞—É–Ω", url: "https://islam.global/verouchenie/koran/sura-107-al-maun-melochi/" },
    108: { name: "–ê–ª—å-–ö–∞–≤—Å–∞—Ä", url: "https://islam.global/verouchenie/koran/sura-108-al-kavsar-izobiliie/" },
    109: { name: "–ê–ª—å-–ö–∞—Ñ–∏—Ä—É–Ω", url: "https://islam.global/verouchenie/koran/sura-109-al-kafirun-nevernye/" },
    110: { name: "–ê–Ω-–ù–∞—Å—Ä", url: "https://islam.global/verouchenie/koran/sura-110-an-nasr-pomoshch" },
    111: { name: "–ê–ª—å-–ú–∞—Å–∞–¥", url: "https://islam.global/verouchenie/koran/sura-111-al-masad-palmovye-volokna/" },
    112: { name: "–ê–ª—å-–ò—Ö–ª—è—Å", url: "https://islam.global/verouchenie/koran/sura-112-al-ikhlas-iskrennost" },
    113: { name: "–ê–ª—å-–§–∞–ª–∞–∫", url: "https://islam.global/verouchenie/koran/sura-113-al-falak-rassvet/" },
    114: { name: "–ê–Ω-–ù–∞—Å", url: "https://islam.global/verouchenie/koran/sura-114-an-nas-liudi/" }
};

let currentSurahId = 1;
let currentAyahNumber = 1;
let allAyat = [];

function loadSurahList() {
    const select = document.getElementById('surahSelect');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—Ä—É...</option>';
    for (const [id, surah] of Object.entries(surahsMap)) {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `${id}. ${surah.name}`;
        select.appendChild(opt);
    }
    loadSurah(1);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—Ä—ã —Å —Ñ–æ–ª–±—ç–∫–æ–º
async function loadSurah(surahId) {
    const loadingEl = document.getElementById('loading-quran');
    const contentEl = document.getElementById('quran-content');
    const errorEl = document.getElementById('error-quran');
    const fullLink = document.getElementById('fullSurahLink');

    loadingEl.style.display = 'block';
    contentEl.style.display = 'none';
    errorEl.style.display = 'none';

    currentSurahId = surahId;
    currentAyahNumber = 1;

    if (!surahsMap[surahId]) {
        showQuranError('–°—É—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }

    const surah = surahsMap[surahId];
    fullLink.href = surah.url;
    fullLink.textContent = `üìñ –ß–∏—Ç–∞—Ç—å "${surah.name}" –Ω–∞ islam.global`;

    try {
        // –§–æ–ª–±—ç–∫: —Å—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—É—Ä—ã
        if (surahId === 1) {
            allAyat = [
                {
                    number: 1,
                    arabic: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê",
                    transcription: "–ë–∏—Å–º–∏–ª–ª—è—Ö–∏—Ä-–†–∞—Ö–º–∞–Ω–∏—Ä-–†–∞—Ö–∏–∏–º",
                    translation: "–í–æ –∏–º—è –ê–ª–ª–∞—Ö–∞, –ú–∏–ª–æ—Å—Ç–∏–≤–æ–≥–æ, –ú–∏–ª–æ—Å–µ—Ä–¥–Ω–æ–≥–æ"
                },
                {
                    number: 2,
                    arabic: "ÿßŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸáŸê ÿ±Ÿéÿ®ŸêŸë ÿßŸÑŸíÿπŸéÿßŸÑŸéŸÖŸêŸäŸÜŸé",
                    transcription: "–ê–ª—å-—Ö–∞–º–¥—É–ª–∏–ª–ª—è—Ö–∏ –†–∞–±–±–∏–ª—å-–∞–ª—è–º–∏–Ω",
                    translation: "–•–≤–∞–ª–∞ –ê–ª–ª–∞—Ö—É ‚Äî –ì–æ—Å–ø–æ–¥—É –º–∏—Ä–æ–≤"
                },
                {
                    number: 3,
                    arabic: "ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê",
                    transcription: "–ê—Ä-–†–∞—Ö–º–∞–Ω–∏—Ä-–†–∞—Ö–∏–º",
                    translation: "–ú–∏–ª–æ—Å—Ç–∏–≤–æ–º—É, –ú–∏–ª–æ—Å–µ—Ä–¥–Ω–æ–º—É"
                },
                {
                    number: 4,
                    arabic: "ŸÖŸéÿßŸÑŸêŸÉŸê ŸäŸéŸàŸíŸÖŸê ÿßŸÑÿØŸêŸëŸäŸÜŸê",
                    transcription: "–ú–∞–ª–∏–∫–∏ —è—É–º–∏–¥-–¥–∏–Ω",
                    translation: "–í–ª–∞–¥—ã–∫–µ –î–Ω—è –°—É–¥–∞"
                },
                {
                    number: 5,
                    arabic: "ÿ•ŸêŸäŸéŸëÿßŸÉŸé ŸÜŸéÿπŸíÿ®ŸèÿØŸè ŸàŸéÿ•ŸêŸäŸéŸëÿßŸÉŸé ŸÜŸéÿ≥Ÿíÿ™ŸéÿπŸêŸäŸÜŸè",
                    transcription: "–ò–π—è–∫–∞ –Ω–∞‚Äô–±—É–¥—É —É–∞ –∏–π—è–∫–∞ –Ω–∞—Å—Ç–∞‚Äô–∏–Ω",
                    translation: "–¢–µ–±–µ –æ–¥–Ω–æ–º—É –º—ã –ø–æ–∫–ª–æ–Ω—è–µ–º—Å—è –∏ –æ—Ç –¢–µ–±—è –æ–¥–Ω–æ–≥–æ –∏—â–µ–º –ø–æ–º–æ—â–∏"
                },
                {
                    number: 6,
                    arabic: "ÿßŸáŸíÿØŸêŸÜŸéÿß ÿßŸÑÿµŸêŸëÿ±Ÿéÿßÿ∑Ÿé ÿßŸÑŸíŸÖŸèÿ≥Ÿíÿ™ŸéŸÇŸêŸäŸÖŸé",
                    transcription: "–ò—Ö–¥–∏–Ω–∞ —Å-—Å–∏—Ä–∞-—Ç–∞–ª—å-–º—É—Å—Ç–∞–∫–∏–º",
                    translation: "–ù–∞—Å—Ç–∞–≤—å –Ω–∞—Å –Ω–∞ –ø—Ä—è–º–æ–π –ø—É—Ç—å"
                },
                {
                    number: 7,
                    arabic: "ÿµŸêÿ±Ÿéÿßÿ∑Ÿé ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ÿ£ŸéŸÜŸíÿπŸéŸÖŸíÿ™Ÿé ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ÿ∫ŸéŸäŸíÿ±Ÿê ÿßŸÑŸíŸÖŸéÿ∫Ÿíÿ∂ŸèŸàÿ®Ÿê ÿπŸéŸÑŸéŸäŸíŸáŸêŸÖŸí ŸàŸéŸÑŸéÿß ÿßŸÑÿ∂ŸéŸëÿßŸÑŸêŸëŸäŸÜŸé",
                    transcription: "–°–∏—Ä–∞-—Ç–∞–ª—è–∑–∏–Ω–∞ –∞–Ω‚Äô–∞–º—Ç–∞ ‚Äô–∞–ª–∞–π—Ö–∏–º, –≥–∞–π—Ä–∏–ª—å-–º–∞–≥-–¥—É–±–∏ ‚Äô–∞–ª–∞–π—Ö–∏–º —É–∞ –ª—è-–¥-–¥–∞–ª–∏–∏–Ω",
                    translation: "–ü—É—Ç—å —Ç–µ—Ö, –∫–æ–º—É –¢—ã –æ–∫–∞–∑–∞–ª –±–ª–∞–≥–æ–¥–µ—è–Ω–∏–µ, –Ω–µ —Ç–µ—Ö, –Ω–∞ –∫–æ–≥–æ –±—ã–ª –≥–Ω–µ–≤, –∏ –Ω–µ –∑–∞–±–ª—É–¥—à–∏—Ö"
                }
            ];
        } else {
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—É—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É-–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–∞–π—Ç
            allAyat = [{
                number: 1,
                arabic: "ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê",
                transcription: "–ë–∏—Å–º–∏–ª–ª—è—Ö–∏—Ä-–†–∞—Ö–º–∞–Ω–∏—Ä-–†–∞—Ö–∏–∏–º",
                translation: "–í–æ –∏–º—è –ê–ª–ª–∞—Ö–∞, –ú–∏–ª–æ—Å—Ç–∏–≤–æ–≥–æ, –ú–∏–ª–æ—Å–µ—Ä–¥–Ω–æ–≥–æ. –ü–æ–ª–Ω–∞—è —Å—É—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ —Å—Å—ã–ª–∫–µ –≤—ã—à–µ."
            }];
        }

        displayAyah(1);
        updateNavigation();

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showQuranError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
}

function displayAyah(ayahNumber) {
    if (!allAyat.length || ayahNumber < 1 || ayahNumber > allAyat.length) return;

    const ayah = allAyat[ayahNumber - 1];
    currentAyahNumber = ayahNumber;

    document.getElementById('arabic-text').textContent = ayah.arabic;
    document.getElementById('transcription-text').textContent = ayah.transcription;
    document.getElementById('translation-text').textContent = ayah.translation;
    document.getElementById('ayah-number').textContent = ayah.number;
    document.getElementById('currentAyahInfo').textContent = `–ê—è—Ç ${ayahNumber} –∏–∑ ${allAyat.length}`;

    document.getElementById('playAudioBtn').disabled = false;
    document.getElementById('playFullSurahBtn').disabled = false;

    updateNavigation();
}

function updateNavigation() {
    const prevBtn = document.getElementById('prevAyahBtn');
    const nextBtn = document.getElementById('nextAyahBtn');
    prevBtn.disabled = currentAyahNumber <= 1;
    nextBtn.disabled = currentAyahNumber >= allAyat.length;
}

function showQuranError(message) {
    const errorEl = document.getElementById('error-quran');
    const loadingEl = document.getElementById('loading-quran');
    const contentEl = document.getElementById('quran-content');
    loadingEl.style.display = 'none';
    contentEl.style.display = 'none';
    errorEl.textContent = message;
    errorEl.style.display = 'block';
}

// –ê—É–¥–∏–æ (—Ä–∞–±–æ—á–∏–µ —Å—Å—ã–ª–∫–∏)
function playAyahAudio() {
    const url = `https://everyayah.com/data/Abdul_Basit_Murattal_64kbps/${String(currentSurahId).padStart(3, '0')}${String(currentAyahNumber).padStart(3, '0')}.mp3`;
    new Audio(url).play().catch(e => alert('–ê—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'));
}

function playFullSurahAudio() {
    const url = `https://server8.mp3quran.net/basit/${String(currentSurahId).padStart(3, '0')}.mp3`;
    new Audio(url).play().catch(e => alert('–ê—É–¥–∏–æ —Å—É—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'));
}

// === –•–ê–î–ò–° –î–ù–Ø ===
const hadiths = [
    { text: "–î–µ–π—Å—Ç–≤–∏—è –∑–∞–≤–∏—Å—è—Ç –æ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–π, –∏ –∫–∞–∂–¥—ã–π –ø–æ–ª—É—á–∏—Ç —Ç–æ, —á—Ç–æ –æ–Ω –Ω–∞–º–µ—Ä–µ–≤–∞–ª—Å—è.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ1" },
    { text: "–ö—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª –º–µ—á–µ—Ç—å —Ä–∞–¥–∏ –ê–ª–ª–∞—Ö–∞, —Ç–æ–º—É –ê–ª–ª–∞—Ö –ø–æ—Å—Ç—Ä–æ–∏—Ç –¥–æ–º –≤ –†–∞—é.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ112" },
    { text: "–õ—É—á—à–∞—è –º–æ–ª–∏—Ç–≤–∞ –ø–æ—Å–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–π ‚Äî —ç—Ç–æ –Ω–æ—á–Ω–∞—è –º–æ–ª–∏—Ç–≤–∞.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ1166" },
    { text: "–ü—è—Ç—å –º–æ–ª–∏—Ç–≤ –≤ –¥–µ–Ω—å –∏ –Ω–æ—á—å ‚Äî –∏—Å–∫—É–ø–ª–µ–Ω–∏–µ –∑–∞ —Ç–æ, —á—Ç–æ –±—ã–ª–æ –º–µ–∂–¥—É –Ω–∏–º–∏, –µ—Å–ª–∏ –Ω–µ —Å–æ–≤–µ—Ä—à–∞–ª–∏—Å—å –±–æ–ª—å—à–∏–µ –≥—Ä–µ—Ö–∏.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ528" },
    { text: "–ü–æ—Å—Ç –≤ –º–µ—Å—è—Ü –†–∞–º–∞–¥–∞–Ω ‚Äî –æ–±—è–∑–∞–Ω –¥–ª—è –≤–∞—Å, –∫–∞–∫ –æ–Ω –±—ã–ª –æ–±—è–∑–∞–Ω–µ–Ω –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –±—ã–ª –¥–æ –≤–∞—Å.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ1897" },
    { text: "–ö—Ç–æ –Ω–µ –æ—Å—Ç–∞–≤–∏—Ç –ª–æ–∂—å, –∫–ª–µ–≤–µ—Ç—É –∏ –¥—É—Ä–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∫–∏, —Ç–æ–º—É –ê–ª–ª–∞—Ö –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã –æ–Ω –æ—Å—Ç–∞–≤–ª—è–ª –µ–¥—É –∏ –ø–∏—Ç—å—ë.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ1903" },
    { text: "–ú–∏–ª–æ—Å–µ—Ä–¥–∏–µ –Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ —Å–µ—Ä–¥—Ü–∞ —á–µ–ª–æ–≤–µ–∫–∞, –∫—Ä–æ–º–µ –∫–∞–∫ —Ä–∞–¥–∏ —É–Ω–∏–∂–µ–Ω–∏—è –æ—Ç –ê–ª–ª–∞—Ö–∞.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ5999" },
    { text: "–£–º–µ–π—Ç–µ –ø—Ä–æ—â–∞—Ç—å –ª—é–¥–µ–π, –∏ –ê–ª–ª–∞—Ö –ø—Ä–æ—Å—Ç–∏—Ç –≤–∞—Å.", ref: "–°–∞—Ö–∏—Ö –∞–ª—å-–ë—É—Ö–∞—Ä–∏, ‚Ññ6491" }
];

function displayRandomHadith() {
    const idx = Math.floor(Math.random() * hadiths.length);
    const h = hadiths[idx];
    document.getElementById('hadith-text').textContent = h.text;
    document.getElementById('hadith-ref').textContent = h.ref;
}

// === –ì–ï–û–õ–û–ö–ê–¶–ò–Ø ===
function getLocation() {
    const btn = document.getElementById('getLocationBtn');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');

    errorDiv.style.display = 'none';
    loading.style.display = 'block';
    btn.disabled = true;

    if (!navigator.geolocation) {
        showError('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.');
        loading.style.display = 'none';
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const { latitude, longitude } = pos.coords;
            fetchPrayerTimes(latitude, longitude);
            showQiblaCompass(latitude, longitude);
        },
        (error) => {
            let msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.';
            if (error.code === 1) msg = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω.';
            else if (error.code === 2) msg = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏.';
            else if (error.code === 3) msg = '–ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.';
            showError(msg);
            loading.style.display = 'none';
            btn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 }
    );
}

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
document.addEventListener('DOMContentLoaded', () => {
    loadSurahList();

    document.getElementById('getLocationBtn').addEventListener('click', getLocation);
    document.getElementById('surahSelect').addEventListener('change', e => {
        if (e.target.value) loadSurah(parseInt(e.target.value));
    });
    document.getElementById('prevAyahBtn').addEventListener('click', () => {
        if (currentAyahNumber > 1) displayAyah(currentAyahNumber - 1);
    });
    document.getElementById('nextAyahBtn').addEventListener('click', () => {
        if (currentAyahNumber < allAyat.length) displayAyah(currentAyahNumber + 1);
    });
    document.getElementById('playAudioBtn').addEventListener('click', playAyahAudio);
    document.getElementById('playFullSurahBtn').addEventListener('click', playFullSurahAudio);

    displayRandomHadith();
});
</script>
{% endblock %}